<!DOCTYPE html>

<html>
	<head>
			
			<title>Bird au Flapper</title>
		
	</head>
	<body>

		<canvas id="canvas" style="width=800; height=600; border: 1px solid red;" ><p> NO HTML5 BADDY </p></canvas>
		
		
		<script type="text/javascript">
			
			var ImageMap = [];
			var ctx;
			var canvas;
			var eventQueue = [];
			
			window.onload = function (e) {
			
				canvas = document.getElementById("canvas");
				ctx = canvas.getContext("2d");
				
				canvas.addEventListener("mousedown", mouseDown, false);
				
				// dummy canvas
				canvas.width = 800;
				canvas.height = 600;
				
				loadImages();
				
				
				var timer = setInterval(function () {
					if(imagesReady()) {
						
						clearInterval(timer);
						
						gameLoop(); 
					}
				
				}, 50);
				
			}
						
			
			function gameLoop() {
				
				var x = 200;
				var y = 100;
				
				var dy = 1;
				
				var points = 0;
				
				var flapdown = 0;
				
				var obstacles = [];
				
				var tick = 0;
				
				var loop = setInterval(function() {
					tick++;
					
					if(tick % 100 == 0) {
					
						var obstacle = {
							x: canvas.width,
							height: (Math.random()*(canvas.height - 200)) + 100,
							gap: 100 + ((100 - tick/600) <  0 ? 0 : (100 - tick/600))
						};
						
						obstacles.push(obstacle);
					}
					
					if(tick > 300 && (tick - 30) % 100 == 0) {
						points++;
					}
					
					for(var ob in obstacles) {
						var tempob = obstacles[ob];
						
						tempob.x -= 3;
					}
					
					console.log
					
					for(var rm = 0; rm < obstacles.length; rm++) {
						if(obstacles[rm] != undefined && obstacles[rm].x < -200) {
							delete obstacles[rm];
						}
					}
					
					
					//render
					clearScreen();
					
					if(flapdown != 0) {
						drawImage('birdy', x, y, 1);
					} else {
						drawImage('birdy', x, y, 0);
					}
					for(var ob in obstacles) {
						var pipe = obstacles[ob];
						drawPipe(pipe);
					}
					drawScore(points);
					
					
					//input
					var input = readUserInput();
					
					if(input == 'click') {
					
						dy = -55;
						flapdown = 8;
					}
					//flapdown animation
					if(flapdown != 0) {
						flapdown--;
					}
					
					//physics
					y += dy/10;
					dy += 3;
					
					if(y < 0) {
						//hit sky
						//alert("YOU HIT THE SKY");
						clearInterval(loop);
						gameLoop(); ;
					}
					if(y > canvas.height) {
						//hit ground
						//alert("CRASH LANDING!");
						clearInterval(loop);
						gameLoop(); ;
					}
					
					for(var ob in obstacles) {
					
						var tempob = obstacles[ob];
						
						if(x+67 >= tempob.x && x < tempob.x + 100) {
							if((y < tempob.height - tempob.gap/2) || (y+50 > tempob.height + tempob.gap/2)) {
								//alert("YOU CRASHED");
								console.log(tick);
								clearInterval(loop);
								gameLoop(); ;
							}
						}					
					}
					
				}, 16);
			
			}
			
			function readUserInput() {
				return eventQueue.pop();
			}
			
			function mouseDown() {
				handleUserEvent('click');
			}
			
			function handleUserEvent(event) {
				
				if(event == 'click') {
					eventQueue.push('click');
				}
			}
			
			function imagesReady() {
				
				var allLoaded = true;
				
				for(var key in ImageMap) {
					allLoaded = allLoaded && ImageMap[key].inited;
				}
				
				return allLoaded;
			}
			
			function loadImages() {
				
				var images = ['birdy.png', 'pipe.png', 'piped.png'];//, 'background.png', 'pipe.png'];
				
				for(var i = 0; i < images.length; i++) {
					var idx = images[i].indexOf('.');
					var imagename = images[i].substring(0, idx);
				
					ImageMap[imagename] = loadImage(images[i]);
				}
				
			}
			
			function loadImage(name) {
				var image = new Image();
				
				image.src = name;
				
				image.inited = false;
				
				image.onload = function () {
				
					image.inited = true;
				}
								
				return image;		
			}
			
			function drawScore(score) {
			
				ctx.fillStyle = "orange";
				ctx.font = "bold 25px Arial";
				ctx.fillText(score, canvas.width - 50, 20);
			}
			
			function drawPipe(pipe) {
			
				var pipeup = ImageMap['pipe'];
				var pipedown = ImageMap['piped'];
				
				
				ctx.drawImage(pipeup, pipe.x, pipe.height + pipe.gap/2);
					
				ctx.drawImage(pipedown, pipe.x, pipe.height - pipe.gap/2 - pipedown.height);
			}
			
			function drawImage(name, xpos, ypos, frame) {
				
				var img = ImageMap[name];
				
				
				var imw = 67;
				var imh = 50;
				
				if(frame != null) {
				
					ctx.drawImage(img, imw*frame, 0, imw, imh, xpos, ypos, imw, imh);
				
				} else {
					ctx.drawImage(img, xpos, ypos);
				}
			}
			
			function clearScreen() {
				ctx.clearRect(0, 0, canvas.width, canvas.height);
			}
			
		</script>
		
	</body>
</html>